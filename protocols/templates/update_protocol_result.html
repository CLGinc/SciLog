{% extends "base/base.html" %}
{% load staticfiles %}
{% block title %}Sci Log - Update result{% endblock %}
{% block body %}
{% include "base/toolbar.html" %}
{% load protocol_extras %}
<header class="mdc-toolbar mdl-color--blue-500 mdc-toolbar--fixed">
  <div class="mdc-toolbar__row padding-16">
    <section class="mdc-toolbar__section mdc-toolbar__section--align-start">
      <a data-mdc-auto-init="MDCRipple"
         class="mdc-button mdl-color-text--white"
         href="{% url 'protocol_result' protocol_uuid=selected_protocol_result.protocol.pk result_uuid=selected_protocol_result.pk %}">
        <i class="material-icons">close</i>
        <span class="toolbar__button-label">Cancel</span>
      </a>
    </section>
    <section class="mdc-toolbar__section">
      <span class="mdc-toolbar__title">Updating result {{ selected_protocol_result.pk }}</span>
    </section>
    <section class="mdc-toolbar__section mdc-toolbar__section--align-end">
      <button data-mdc-auto-init="MDCRipple"
              data-trigger="submit-result"
              data-form="create_protocol_result_form"
              class="mdc-button mdl-color-text--white">
        <i class="material-icons">check</i>
        <span class="toolbar__button-label">Save</span>
      </button>
    </section>
  </div>
</header>
<div class="content">
{% include "base/drawer.html" %}
  <div class="main-grid mdc-layout-grid">
    <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12">
      <h1 class="mdc-typography--headline mdl-color-text--blue-500 subpageheader">
        Result details
      </h1>
      <div>
        {% if form.nonfield_errors %}
          {{ form.nonfield_errors }}
        {% endif %}
        {% if data_columns_formset.nonfield_errors %}
          {{ data_columns_formset.nonfield_errors }}
        {% endif %}
      </div>
      <form class="mdc-layout-grid mdc-layout-grid__cell mdc-layout-grid__cell--span-12 margin--none padding-0"
            id="create_protocol_result_form"
            method="post"
            action="">
        {% csrf_token %}
        {{ data_columns_formset.management_form }}
        <input class="hidden" name="protocol" value="{{ form.protocol.value }}"/>
        <div class="mdc-layout-grid mdc-layout-grid__cell mdc-layout-grid__cell--span-12 margin--none padding-0">
          <div class="mdc-layout-grid mdc-layout-grid__cell mdc-layout-grid__cell--span-3 margin--none padding-0">
            <p class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12 mdl-color-text--light-blue-500 mdc-typography--subhead">Status</p>
            <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12 margin--none">
              <div class="mdc-form-field {% if form.is_successful.errors %}mdc-textfield--invalid{% endif %}">
                <div class="mdc-checkbox">
                  <input type="checkbox"
                         id="success-checkbox"
                         name="is_successful"
                         {% if form.is_successful.value %}checked{% endif %}
                         class="mdc-checkbox__native-control"/>
                  <div class="mdc-checkbox__background">
                    <svg class="mdc-checkbox__checkmark"
                         viewBox="0 0 24 24">
                      <path class="mdc-checkbox__checkmark__path"
                            fill="none"
                            stroke="white"
                            d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                    </svg>
                    <div class="mdc-checkbox__mixedmark"></div>
                  </div>
                </div>
                <label for="success-checkbox">Success</label>
              </div>
              {% if form.is_successful.errors %}
              <p class="mdc-textfield-helptext mdc-textfield-helptext--persistent mdc-textfield-helptext--validation-msg" role="alert">
                {{ form.is_successful.errors.as_text }}
              </p>
              {% endif %}
            </div>
          </div>
          <div class="mdc-layout-grid mdc-layout-grid__cell mdc-layout-grid__cell--span-3 margin--none padding-0">
            <p class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12 mdl-color-text--light-blue-500 mdc-typography--subhead">State</p>
            <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12 margin--none">
              <select class="mdc-select margin--none" name="state">
                {% for key, value in form.state.field.choices %}
                <option value="{{ key }}" {% if form.state.value == key %}selected{% endif %}>{{ value }}</option>
                {% endfor %}
              </select>
            </div>
            {% if form.state.errors %}
              <p class="mdc-textfield-helptext mdc-textfield-helptext--persistent mdc-textfield-helptext--validation-msg" role="alert">
                {{ form.state.errors.as_text }}
              </p>
            {% endif %}
          </div>
          <div class="mdc-layout-grid mdc-layout-grid__cell mdc-layout-grid__cell--span-3 margin--none padding-0">
            <p class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12 mdl-color-text--light-blue-500 mdc-typography--subhead">Link to project</p>
            <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12 margin--none">
              <div class="mdc-textfield {% if form.project.errors %}mdc-textfield--invalid{% endif %} input--simple" data-mdc-auto-init="MDCTextfield">
                <input class="mdc-textfield__input"
                       id="link_result_to_project_input_name"
                       type="text"
                       autocomplete="off"
                       maxlength="255">
                <label class="mdc-textfield__label{% if form.project.value %} mdc-textfield__label--float-above{% endif %}">Start typing project name</label>
                <input type="text"
                       name="project"
                       class="hidden"
                       {% if form.project.value %}value="{{ form.project.value }}"{% endif %}
                       id="link_result_to_project_input_uuid">
              </div>
              {% if form.project.errors %}
                <p class="mdc-textfield-helptext mdc-textfield-helptext--persistent mdc-textfield-helptext--validation-msg" role="alert">
                  {{ form.project.errors.as_text }}
                </p>
              {% endif %}
            </div>
            {% if form.state.errors %}
              <p class="mdc-textfield-helptext mdc-textfield-helptext--persistent mdc-textfield-helptext--validation-msg" role="alert">
                {{ form.state.errors.as_text }}
              </p>
            {% endif %}
          </div>
          <div class="mdc-layout-grid mdc-layout-grid__cell mdc-layout-grid__cell--span-3 margin--none padding-0">
            <p class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12 mdl-color-text--light-blue-500 mdc-typography--subhead">Linked protocol</p>
            <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12 margin--none">
              {{ selected_protocol_result.protocol.name }}
            </div>
          </div>
        </div>
        <div class="mdc-layout-grid mdc-layout-grid__cell mdc-layout-grid__cell--span-12 margin--none padding--top-24 padding-0">
          <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-6 margin--none padding-0">
            <p class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12 mdl-color-text--light-blue-500 mdc-typography--subhead">Result note</p>
            <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12 margin--none">
              <div class="mdc-textfield {% if form.note.errors %}mdc-textfield--invalid{% endif %}" data-mdc-auto-init="MDCTextfield">
                <input class="mdc-textfield__input" type="text"
                       name="note"
                       maxlength="255" {% if form.note.value %}value="{{ form.note.value }}"{% endif %}>
                <label class="mdc-textfield__label">Add a note for this result</label>
              </div>
              {% if form.note.errors %}
              <p class="mdc-textfield-helptext mdc-textfield-helptext--persistent mdc-textfield-helptext--validation-msg" role="alert">
                {{ form.note.errors.as_text }}
              </p>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="mdc-layout-grid mdc-layout-grid__cell mdc-layout-grid__cell--span-12 margin--none padding-0">
          <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12 mdl-color-text--light-blue-500 mdc-typography--subhead">
            <span>Data tables</span>
            <div data-mdc-auto-init="MDCRipple"
               href="#"
               data-trigger="addDataColumn"
               class="mdc-button mdl-color-text--blue-grey-600 right">
              <i class="material-icons mdl-color-text--blue-500">playlist_add</i> Add data column
            </div>
          </div>
          <div class="mdc-layout-grid mdc-layout-grid__cell mdc-layout-grid__cell--span-12 margin--none padding-0" data-content="dataTable--parent">
            {% for data_column_form in data_columns_formset.forms %}
            <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-3 dataTable--column" data-order="{{ data_column_form.order.value }}">
              <input class="hidden" name="data_columns-{{ data_column_form.order.value }}-result" value="{{ data_column_form.result.value }}" id="id_data_columns-{{ data_column_form.order.value }}-result">
              <input class="hidden"
                     name="data_columns-{{ data_column_form.order.value }}-id"
                     data-content="id"
                     value="{{ data_column_form.id.value }}"
                     id="id_data_columns-{{ data_column_form.order.value }}-id">
              <input type="checkbox"
                     class="hidden"
                     data-content="delete-table"
                     name="data_columns-{{ data_column_form.order.value }}-DELETE"
                     id="id_data_columns-{{ data_column_form.order.value }}-DELETE">
              <input type="text"
                     name="data_columns-{% if data_column_form.order.value %}{{ data_column_form.order.value }}{% else %}0{% endif %}-order"
                     value="{% if data_column_form.order.value %}{{ data_column_form.order.value }}{% else %}0{% endif %}"
                     data-content="order"
                     class="hidden">
              <textarea name="data_columns-{% if data_column_form.order.value %}{{ data_column_form.order.value }}{% else %}0{% endif %}-data"
                        data-content="data-merged"
                        class="hidden">{% if data_column_form.data.value %}value="{{ data_column_form.data.value }}"{% endif %}</textarea>
              <table class="mdl-data-table mdl-js-data-table mdl-shadow--2dp">
                <thead>
                  <tr>
                    <th class="mdl-data-table__cell--non-numeric" colspan="2">Title</th>
                    <th>
                      <i class="material-icons list--link-remove"
                        data-trigger="delete-table">clear</i>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="mdl-data-table__cell--non-numeric" colspan="3">
                      <input type="text"
                             class="width--full"
                             name="data_columns-{% if data_column_form.order.value %}{{ data_column_form.order.value }}{% else %}0{% endif %}-title"
                             data-content="title"
                             {% if data_column_form.title.value %}value="{{ data_column_form.title.value }}"{% endif %}>
                       {% if data_column_form.title.errors %}
                         <p class="mdc-textfield-helptext mdc-textfield-helptext--persistent mdc-textfield-helptext--validation-msg" role="alert">
                           {{ data_column_form.title.errors.as_text }}
                         </p>
                       {% endif %}
                    </td>
                  </tr>
                </tbody>
                <thead>
                  <tr>
                    <th class="mdl-data-table__cell--non-numeric" colspan="2">Measurement</th>
                    <th class="mdl-data-table__cell--non-numeric">Unit</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="mdl-data-table__cell--non-numeric" colspan="2">
                      <div class="mdc-textfield {% if data_column_form.measurement.errors %}mdc-textfield--invalid{% endif %}">
                        <input type="text"
                               class="width--full"
                               name="data_columns-{% if data_column_form.order.value %}{{ data_column_form.order.value }}{% else %}0{% endif %}-measurement"
                               data-content="measurement"
                               {% if data_column_form.measurement.value %}value="{{ data_column_form.measurement.value }}"{% endif %}>
                      </div>
                      {% if data_column_form.measurement.errors %}
                       <p class="mdc-textfield-helptext mdc-textfield-helptext--persistent mdc-textfield-helptext--validation-msg" role="alert">
                         {{ data_column_form.measurement.errors.as_text }}
                       </p>
                      {% endif %}
                    </td>
                    <td class="mdl-data-table__cell--non-numeric">
                      <div class="mdc-textfield {% if data_column_form.measurement.errors %}mdc-textfield--invalid{% endif %}">
                        <input type="text"
                               class="width--full"
                               name="data_columns-{% if data_column_form.order.value %}{{ data_column_form.order.value }}{% else %}0{% endif %}-unit"
                               data-content="unit"
                               {% if data_column_form.unit.value %}value="{{ data_column_form.unit.value }}"{% endif %}>
                      </div>
                      {% if data_column_form.unit.errors %}
                        <p class="mdc-textfield-helptext mdc-textfield-helptext--persistent mdc-textfield-helptext--validation-msg" role="alert">
                          {{ data_column_form.unit.errors.as_text }}
                        </p>
                      {% endif %}
                    </td>
                  </tr>
                </tbody>
                <thead>
                  <tr>
                    <th class="mdl-data-table__cell--non-numeric" colspan="2">Data</th>
                    <th>
                      remove / add
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {% if data_column_form.data.value %}
                    {% with data_dict=data_column_form.data.value|json_to_dict %}
                      {% for data_value in data_dict.Data %}
                        <tr>
                          <td class="mdl-data-table__cell--non-numeric" colspan="2">
                            <input class="width--full"
                                   data-content="data"
                                   value="{{ data_value }}">
                          </td>
                          <td>
                            <i class="material-icons list--link-remove" data-trigger="remove--datarow" data-mdc-auto-init="MDCRipple">clear</i>
                            <i class="material-icons list--link-add" data-trigger="add--datarow">add</li>
                          </td>
                        </tr>
                        {% endfor %}
                    {% endwith %}
                  {% else %}
                  <tr>
                    <td class="mdl-data-table__cell--non-numeric" colspan="2">
                      <input class="width--full"
                             data-content="data">
                    </td>
                    <td>
                      <i class="material-icons list--link-remove" data-trigger="remove--datarow">clear</i>
                      <i class="material-icons list--link-add" data-trigger="add--datarow">add</li>
                    </td>
                  </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
            {% endfor %}
            {% if data_column_form.value.errors %}
              <p class="mdc-textfield-helptext mdc-textfield-helptext--persistent mdc-textfield-helptext--validation-msg" role="alert">
                {{ data_column_form.value.errors.as_text }}
              </p>
            {% endif %}
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
<div id="modal--attachments" class="modal visible mdc-layout-grid">
  <div class="article--modal padding-0 mdc-elevation--z16 mdc-layout-grid__cell mdc-layout-grid__cell--span-12">
    <header class="mdc-toolbar mdl-color--blue-500 mdc-elevation--z2">
      <div class="mdc-toolbar__row padding-16">
        <section class="mdc-toolbar__section mdc-toolbar__section--align-start">
          <a data-mdc-auto-init="MDCRipple"

             data-target="modal--attachments"
             class="mdc-button mdl-color-text--white">
            <i class="material-icons">close</i>
            <span class="toolbar__button-label">Cancel</span>
          </a>
        </section>
        <section class="mdc-toolbar__section">
          <span class="mdc-toolbar__title">Select files to attach</span>
        </section>
        <section class="mdc-toolbar__section mdc-toolbar__section--align-end">
          <button data-mdc-auto-init="MDCRipple"
                  data-form="create_protocol_result_form"
                  class="mdc-button mdl-color-text--white">
            <i class="material-icons">check</i>
            <span class="toolbar__button-label">Done</span>
          </button>
        </section>
      </div>
    </header>
    <div id="add_attachments" class="modal--content">
      <form action="/file-upload" class="dropzone">
        <div class="fallback">
          <input name="file" type="file" multiple />
        </div>
      </form>
    </div>
  </div>
</div>
<button data-mdc-auto-init="MDCRipple"
        data-trigger="show"
        data-target="modal--attachments"
        id="button-add"
        class="button--attachments mdc-fab mdc-fab--mini material-icons mdl-color--blue-500">
  <span  class="mdc-fab__icon">cloud_upload</span>
</button>
<div class="mdc-snackbar mdl-color--blue-500"
     aria-live="assertive"
     aria-atomic="true"
     aria-hidden="true" id="mdc-js-snackbar">
  <div class="mdc-snackbar__text"></div>
  <div class="mdc-snackbar__action-wrapper">
    <button type="button" class="mdc-button mdc-snackbar__action-button"></button>
  </div>
</div>
{% include "base/scroll_top.html" %}
{% endblock %}
{% block post_load %}
<script type = "text/javascript" src="{% static "front/js/ajax.js" %}"></script>
<script type = "text/javascript" src="{% static "front/js/triggers.js" %}"></script>
<script type = "text/javascript" src="{% static "front/js/datacolumns.js" %}"></script>
<script type = "text/javascript" src="{% static "front/js/dropzone.js" %}"></script>
<script type = "text/javascript" src="{% static "front/js/jquery.auto-complete.min.js" %}"></script>
<script>
  var MDCSnackbar = mdc.snackbar.MDCSnackbar;
  var snackbar = new MDCSnackbar(document.getElementById('mdc-js-snackbar'));
  var show = function(sb,notif) {
    var data =  {
      message: notif
    };
    sb.show(data);
  };
  $(window).load(function(){
    var projectInErroruuid = $('#link_result_to_project_input_uuid').val();
    $('#link_result_to_project_input_name').val(choices[projectInErroruuid]);
  });
  var choices = { {% for project_uuid, project_name in form.project.field.choices %}"{{ project_uuid }}":"{{ project_name }}"{% if not forloop.last %},{% endif %}{% endfor %} };
  $('#link_result_to_project_input_name').autoComplete({
      minChars: 0,
      source: function(term, suggest){
          term = term.toLowerCase();
          var suggestions = [];
          $.each(choices, function(key, value){
            suggestions.push([key, value]);
          });
          suggest(suggestions);
      },
      renderItem: function (item, search){
          search = search.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
          var re = new RegExp("(" + search.split(' ').join('|') + ")", "gi");
          return '<div class="autocomplete-suggestion" data-pname="'+item[1]+'" data-puuid="'+item[0]+'" data-val="'+search+'">'+item[1].replace(re, "<b>$1</b>")+'</div>';
      },
      onSelect: function(e, term, item){
          $('#link_result_to_project_input_name').val(item.value('pname'));
          $('#link_result_to_project_input_uuid').val(item.value('puuid'));
      }
  });
  </script>
{% endblock %}
